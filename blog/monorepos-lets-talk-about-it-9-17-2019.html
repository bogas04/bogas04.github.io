<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><title>Monorepos, lets talk about it | Blog | Divjot Singh</title><meta name="title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta name="description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I’m guessing you must have faced some…"/><meta name="keywords" content="git, repository, monorepos, coding, lerna, javascript"/><meta property="og:type" content="website"/><meta property="og:url" content="https://bogas04.github.io/blog/monorepos-lets-talk-about-it-9-17-2019"/><meta property="og:title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta property="og:description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I’m guessing you must have faced some…"/><meta property="og:image" content="https://bogas04.github.io//img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:url" content="https://bogas04.github.io/blog/monorepos-lets-talk-about-it-9-17-2019"/><meta property="twitter:title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta property="twitter:description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I’m guessing you must have faced some…"/><meta property="twitter:image" content="https://bogas04.github.io//img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="#333333" name="theme-color"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-110963096-1"></script><script>
                window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }
                gtag('js', new Date());

                gtag('config', 'UA-110963096-1');

                (function (d, s, scripts) {
                    var js,
                        fjs = d.getElementsByTagName(s)[0];
                    for (var i = 0; i < scripts.length; i++) {
                        if (!d.getElementById(scripts[i].id)) {
                            js = d.createElement(s);
                            js.id = scripts[i].id;
                            js.src = scripts[i].url;
                            fjs.parentNode.insertBefore(js, fjs);
                        }
                    }
                })(document, "script", [
                    { id: "google-platform", url: "//apis.google.com/js/platform.js" }
                ]);
            </script><meta name="next-head-count" content="19"/><link rel="preload" href="/_next/static/css/78d57f11866ff087f1bc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/78d57f11866ff087f1bc.css"/><link rel="preload" href="/_next/static/x77_76NIwkTwQVLdJzAyE/pages/_app.js" as="script"/><link rel="preload" href="/_next/static/x77_76NIwkTwQVLdJzAyE/pages/blog/%5Bslug%5D.js" as="script"/><link rel="preload" href="/_next/static/runtime/webpack-c212667a5f965e81e004.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.c6faae2799416a6da8e8.js" as="script"/><link rel="preload" href="/_next/static/chunks/8fa8195c484ff359de37c3e3df3e65db45e45c31.6410b8472f12f4cd5b7b.js" as="script"/><link rel="preload" href="/_next/static/chunks/f0ed4caab1caa1cdeb590ac7284e018c51b635b3.01cf6ee79894c0f4522a.js" as="script"/><link rel="preload" href="/_next/static/runtime/main-4cc3e642b9eb61ccb22a.js" as="script"/><link rel="preload" href="/_next/static/chunks/70596abf1b61d8bcb70c0714f534e0fb4f2d0437.402fba793ca95f8ab99b.js" as="script"/><style data-styled="" data-styled-version="5.1.0"></style></head><body><div id="__next"><style>
        main {
            position: relative;
            max-width: 56em;
            background-color: white;
            padding: 2em;
            margin: 0 auto;
            box-sizing: border-box;
        }

        img {
            width: 100%;
        }

        @media (prefers-color-scheme: dark) {
            body,
            main {
                background: #333;
                color: white;
            }

            a {
                color: lightsalmon;
            }
        }
    </style><main><style>
  .content h2 {
    font-size: 1.6em;
    margin: 1em 0;
    font-weight: 500;
  }

  .content h3 {
    font-size: 1.2em;
    margin: 0.8em 0;
    font-weight: 500;
  }

  .content img,
  .content h4 {
    margin: 1em 0;
  }

  .content pre {
    background-color: #f9f9f9;
    box-shadow: inset 1px 1px 5px rgba(0, 0, 0, 0.05);
    padding: 0.5em;
    border-radius: 2px;
    overflow-x: auto;
  }

  .content pre code {
    background-color: transparent;
    padding: 0;
  }

  @media (prefers-color-scheme: dark) {
    .content pre {
      color: black;
    }
  }

  .content ul {
    line-height: 1.5;
  }

  .content li {
    margin: 0 0 0.5em 0;
  }
  h4 {
    text-transform: capitalize;
    margin-bottom: 2em;
  }
  h4 p{
    margin: 0.4em 0;
  }</style><h1>Monorepos, lets talk about it</h1><h4><a href="/">Divjot Singh</a> <!-- -->|<!-- --> <a href="/blog">Blog</a> <!-- -->| <!-- -->Tue Sep 17 2019<br/><p>git, repository, monorepos, coding, lerna, javascript</p></h4><div class="content"><img src="/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png" alt="Image credits: undraw"><br />Recall the days when you were just introduced to <code>git</code> or a similar type of version control system. I’m guessing you must have faced some friction initially, how it breaks your flow, how you just can’t merge to master without rebasing/merging changes in first.<br />Despite that, you might agree today that it’s actually very helpful in collaborating with the team, and those pain points were necessary to get here.<br />Monorepos are somewhat similar.<br />While git was solving problems around managing single codebase with multiple team members or just better versioning, Monorepo kind of does the same but for multiple projects/codebases.<h3>The what.</h3><blockquote>Is Monorepo that cool font I see on Twitter?</blockquote><br /><img src="/img/blog/1__ZzlBaQH6w1BgwZdo3bIYRQ.png" alt="Image credits: undraw"><br />Before diving into the topic, let’s first understand what Monorepo truly means. This is what Wikipedia has to say:<br /><blockquote>In revision control systems, a Monorepo is a software development strategy where code for many projects are stored in the same repository.</blockquote><br />In other words, your ‘Work’ folder is close to what a Monorepo would look like. It would have packages that deal with server, web app, native app, documentation, etc.<br />This is different from a ‘monolith’ where all your application logic is<br />centralized to one entry point as opposed to distributed services (microservices).<br />While code for various services would sit in a single repository, it doesn’t mean it would be deployed as a single entity, just like your ‘Work’ folder. Individual projects have separate life-cycles.<h3>The why.</h3><blockquote>So, do I just <code>git add</code> my entire ‘Work’ folder?</blockquote><br /><blockquote>“Why would you want to do this? Whatever happened to separation of concern?”</blockquote><br />There are several arguments both in favour and against Monorepos. And I don’t mean “Oh Google uses it” kind of arguments. This blog will give a sneak-peek into our problems and Monorepo’s solutions to them.<br />Regardless, I recommend that you identify the problems your codebase is facing, and see if Monorepo is truly the answer to those.<h3>The story.</h3>Before moving to Monorepo, we as a team worked on 3 codebases at the same time;<br /><ul><li><strong>dweb</strong> (Desktop website of Swiggy)</li><li><strong>mweb</strong> (Mobile website of Swiggy)</li><li><strong>service</strong> (API proxy NodeJS middleware, used by dweb and mweb)</li></ul><br />When I say work, I mean writing features, updating build pipeline, reviewing code and fixing bugs.<br />As the codebases grew, we recognized some patterns:<br /><img src="/img/blog/1____L__bUfSLVT6EboXRO7SSGg.png" alt="Image credits: undraw"><br /><ul><li>Features written on mweb, while dissimilar enough to not to be dragged and dropped to dweb, held enough similarities to be broken into reusable parts.</li><li>Fixes that go on mweb are also needed on dweb.</li><li>Code reviewers often ended up reviewing the same code (between mweb and dweb) in a slightly different context.</li><li>Code review changes on dweb are also relevant to mweb</li><li>Changes to contracts of service, a common dependency, are also needed to be individually coded, tested, and reviewed.</li><li>Updating dependencies like <a href="https://reactjs.org/">React</a>/<a href="https://webpack.js.org/">Webpack</a>/<a href="https://babeljs.io/">Babel</a> becomes cumbersome between the two codebases.</li><li>Conventions are difficult to enforce between the three repositories. One has an older version of <a href="https://eslint.org/">ESLint</a>, one hasn’t been updated when new lint rules were added, one is still using old test runner.</li><li>Attempts to make a new repository to keep common code failed due to the amount of setup and code management. Imagine working with multiple team members on multiple repositories with multiple Pull Requests.</li></ul><br />As you can see, while the projects are very different (check out <a href="https://portal-sentry.swiggyapp.com/settings/swiggy/go-front-staging/keys/">swiggy.com</a> on your desktop and mobile to realize that), they still have quite a lot of common code interactions.<br /><blockquote>Bike-shedding: Have you tried <a href="https://www.swiggy.com?utm_source=medium">Swiggy</a> website on your desktop or mobile browser? We would love to hear your feedback!</blockquote><h3>The how.</h3><img src="/img/blog/1__0WjBWfdkbcob39FMklwp7A.png" alt="Logo of Lerna"><br /><a href="https://lerna.js.org/">https://lerna.js.org/</a><br />Depending on your ecosystem, there will be different tools to help you with maintaining a Monorepo. You can obviously go vanilla and just use different folders per project. We use <a href="https://lerna.js.org/">Lerna</a> for maintaining our JavaScript codebase.<br />Thanks to its community, there’s a <a href="https://github.com/lerna/lerna/tree/master/commands/publish">lot</a> <a href="https://github.com/lerna/lerna/blob/master/FAQ.md">of</a> <a href="https://lerna.js.org/#commands">documentation</a> and <a href="https://medium.com/mitterio/multirepo-to-lerna-js-monorepo-80f6657cb443">help</a> for Lerna <a href="https://github.com/lerna/lerna/blob/master/doc/troubleshooting.md">related</a> <a href="https://github.com/lerna/lerna/blob/master/doc/guides.md">queries</a>.<br /><pre class="code bash"># Install lerna globally
npm i -g lerna

# Change directory to your work folder
cd ~/Work

# Make the folder you want to keep your monorepo in
mkdir portal-web

# Change directory to monorepo folder
cd portal-web

# Initialize lerna (it will handle `git init`)
lerna init

# Commit the changes
git add . && git commit -m &quot;Initial commit&quot;

# Import other packages (https://github.com/lerna/lerna/tree/master/commands/import)
lerna import ~/Work/portal-mweb

# That's pretty much it!

# Fun fact: If you want to rename your package, simply rename the folder before importing.
# Fun fact 2: You might need to flatten out the commits in most cases (https://github.com/lerna/lerna/tree/master/commands/import#--flatten)</pre><br />You may use <a href="https://gist.github.com/bogas04/874731db80967c040209fea396bf7804">above scripts</a> to import existing repositories to a lerna based monorepo.<br />Running scripts from the root has been made simpler using these handy <a href="https://docs.npmjs.com/misc/scripts">npm scripts</a>.<br />These scripts allow for convenient way to invoke package scripts from root folder<br />Since our packages are hosted in <a href="https://verdaccio.org/">internal npm registry</a>, we inject a .npmrc in our <a href="https://jenkins.io/">Jenkins</a> build the pipeline to avoid committing the authToken.<br />A script to find all scoped dependencies of a project<br /><pre class="code bash"># Install monorepo dependencies from internal npm registry
npm i `../../scripts/scope-packages.js @portal`

# Fun fact:
# `npm i &lt;package-name&gt;` would also install other dependencies if they aren't present in node_modules,
# along with the mentioned &lt;package-name&gt;

# Fun fact 2:
# In presence of package-lock.json, `npm i` would use those version numbers instead of fetching the latest ones
# This essentially makes it a hybrid of `npm i` and `npm ci`</pre><br />One interesting thing about <a href="https://lerna.js.org/">Lerna</a> is that it <a href="https://gist.github.com/bogas04/8c9702aba064b03b1162a0058c7b8f98">doesn’t</a> want private packages to be part of the <code>package-lock.json.</code> This means we can’t just simply use <code>npm ci</code>. We use this bash script to get past that.<h3>The happy part.</h3>Within a few months of making this change, we tippled the number of packages in our Monorepo. We also saw much more work done on the linting front, leading to a more consistent codebase.<br />The linter is common to entire Monorepo, and each new rule affects all the packages.<br /><ul><li><strong>config</strong> (webpack config as a package, reused by mweb and dweb)</li><li><strong>ui</strong> (a package to create common patterns of design to be used in mobile and desktop, thus enabling us to work on creating a Swiggy’s design system)</li><li><strong>payments</strong> (a package of Swiggy’s payments page, used by multiple tenants)</li><li><strong>reviews</strong> (a package of Swiggy’s Ratings and Reviews page and components, used by mweb and dweb)</li><li><strong>helpers</strong> (a package of common reusable logic, something like lodash)</li><li><strong>daily</strong> (swiggydaily.com, reuses 2 components from mweb)</li><li><strong>cache</strong> (a caching module used by mweb and dweb)</li><li><strong>restaurant-url</strong> (a restaurant slug generator, multiple tenants)</li></ul><br /><img src="/img/blog/1__kvwGrM__62LBXWLHxH__QwGw.png" alt="Image credits: undraw"><br />I think that giving the option to easily create a new package incentivizes developers to think in more modular terms. They don’t think in the context of an app but rather in a more general way.<br />It also discourages them from touching modules that are used by multiple tenants, and use <a href="https://semver.org/">semantic versioning</a> appropriately.<br />The benefits we are seeing out of this are just amazing:<br /><ul><li>Writing the same fix for dweb and mweb is faster, as it’s just one commit.</li><li>No more <code>npm link</code> mess.</li><li>Reviewing a fix for both dweb and mweb is faster, as it’s just one Pull Request on one repository by one team member.</li><li>Reusing and updating build pipeline is much more seamless.</li><li>Updating major dependencies/lint rules is super easy.</li><li>The collocation of code encourages developers to copy-paste less and reuse more.</li><li>Writing reusable modules becomes easier, leading to better software engineering.</li></ul><h3>The sad part.</h3>But it ain’t all fun. Our PR section is a bit noisier. It’s not like we’re somehow writing more code, but that changes to any package comes to spotlight and doesn’t get silently updated.<br /><ul><li>Too many packages lead to longer bootstrap times.</li><li>Leveraging the benefits of Monorepo takes time.</li><li>The code navigation is slightly slower. Developers are now opening individual packages to work around that.</li></ul><br /><strong>Update:</strong> There’s one more point I would like to touch upon. Our approach currently colocates applications with libraries. ‘mweb’ is a private package in the sense it isn’t published to our npm registry, however ‘ui’ is a public package that can be consumed by mulitple tenants. This leads to heterogeneity in the monorepo. We are okay with this mix as<br /><ul><li>it reduces friction of local development (no npm links).</li><li>colocation leads to easy refactors and library creations.</li><li>code review is simpler when it’s all one repository.</li></ul><h3>The verdict.</h3>So far we’re seeing Monorepo architecture a better fit for our growing codebase and team. It also impacts the way we design new libraries and components, often promoting clearer separations of concerns.<br /><img src="/img/blog/1__O3UIYiDjYTXMAZd7GBMwVg.png" alt="Image credits: undraw"><br />Should you use monorepo? Like all things, it depends on TM! I hope this blog gave enough insight to you as to why we started using a Monorepo, and how it’s benefiting us.<br /><blockquote>DISCLAIMER: We don’t advocate for any of the tools, libraries, coding practices or software development philosophies mentioned here. You are welcome to read, learn, accept, reject and critique however you see fit.</blockquote></div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Monorepos, lets talk about it","description":"Recall the days when you were just introduced to git or a similar type ofversion control system. I’m guessing you must have faced some…","date":"2019-09-17T07:55:58.095Z","categories":"[]","keywords":["git","repository","monorepos","coding","lerna","javascript"],"slug":"monorepos-lets-talk-about-it-9-17-2019","image":"/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png","html":"\u003cimg src=\"/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png\" alt=\"Image credits: undraw\"\u003e\u003cbr /\u003eRecall the days when you were just introduced to \u003ccode\u003egit\u003c/code\u003e or a similar type of version control system. I’m guessing you must have faced some friction initially, how it breaks your flow, how you just can’t merge to master without rebasing/merging changes in first.\u003cbr /\u003eDespite that, you might agree today that it’s actually very helpful in collaborating with the team, and those pain points were necessary to get here.\u003cbr /\u003eMonorepos are somewhat similar.\u003cbr /\u003eWhile git was solving problems around managing single codebase with multiple team members or just better versioning, Monorepo kind of does the same but for multiple projects/codebases.\u003ch3\u003eThe what.\u003c/h3\u003e\u003cblockquote\u003eIs Monorepo that cool font I see on Twitter?\u003c/blockquote\u003e\u003cbr /\u003e\u003cimg src=\"/img/blog/1__ZzlBaQH6w1BgwZdo3bIYRQ.png\" alt=\"Image credits: undraw\"\u003e\u003cbr /\u003eBefore diving into the topic, let’s first understand what Monorepo truly means. This is what Wikipedia has to say:\u003cbr /\u003e\u003cblockquote\u003eIn revision control systems, a Monorepo is a software development strategy where code for many projects are stored in the same repository.\u003c/blockquote\u003e\u003cbr /\u003eIn other words, your ‘Work’ folder is close to what a Monorepo would look like. It would have packages that deal with server, web app, native app, documentation, etc.\u003cbr /\u003eThis is different from a ‘monolith’ where all your application logic is\u003cbr /\u003ecentralized to one entry point as opposed to distributed services (microservices).\u003cbr /\u003eWhile code for various services would sit in a single repository, it doesn’t mean it would be deployed as a single entity, just like your ‘Work’ folder. Individual projects have separate life-cycles.\u003ch3\u003eThe why.\u003c/h3\u003e\u003cblockquote\u003eSo, do I just \u003ccode\u003egit add\u003c/code\u003e my entire ‘Work’ folder?\u003c/blockquote\u003e\u003cbr /\u003e\u003cblockquote\u003e“Why would you want to do this? Whatever happened to separation of concern?”\u003c/blockquote\u003e\u003cbr /\u003eThere are several arguments both in favour and against Monorepos. And I don’t mean “Oh Google uses it” kind of arguments. This blog will give a sneak-peek into our problems and Monorepo’s solutions to them.\u003cbr /\u003eRegardless, I recommend that you identify the problems your codebase is facing, and see if Monorepo is truly the answer to those.\u003ch3\u003eThe story.\u003c/h3\u003eBefore moving to Monorepo, we as a team worked on 3 codebases at the same time;\u003cbr /\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003edweb\u003c/strong\u003e (Desktop website of Swiggy)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003emweb\u003c/strong\u003e (Mobile website of Swiggy)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eservice\u003c/strong\u003e (API proxy NodeJS middleware, used by dweb and mweb)\u003c/li\u003e\u003c/ul\u003e\u003cbr /\u003eWhen I say work, I mean writing features, updating build pipeline, reviewing code and fixing bugs.\u003cbr /\u003eAs the codebases grew, we recognized some patterns:\u003cbr /\u003e\u003cimg src=\"/img/blog/1____L__bUfSLVT6EboXRO7SSGg.png\" alt=\"Image credits: undraw\"\u003e\u003cbr /\u003e\u003cul\u003e\u003cli\u003eFeatures written on mweb, while dissimilar enough to not to be dragged and dropped to dweb, held enough similarities to be broken into reusable parts.\u003c/li\u003e\u003cli\u003eFixes that go on mweb are also needed on dweb.\u003c/li\u003e\u003cli\u003eCode reviewers often ended up reviewing the same code (between mweb and dweb) in a slightly different context.\u003c/li\u003e\u003cli\u003eCode review changes on dweb are also relevant to mweb\u003c/li\u003e\u003cli\u003eChanges to contracts of service, a common dependency, are also needed to be individually coded, tested, and reviewed.\u003c/li\u003e\u003cli\u003eUpdating dependencies like \u003ca href=\"https://reactjs.org/\"\u003eReact\u003c/a\u003e/\u003ca href=\"https://webpack.js.org/\"\u003eWebpack\u003c/a\u003e/\u003ca href=\"https://babeljs.io/\"\u003eBabel\u003c/a\u003e becomes cumbersome between the two codebases.\u003c/li\u003e\u003cli\u003eConventions are difficult to enforce between the three repositories. One has an older version of \u003ca href=\"https://eslint.org/\"\u003eESLint\u003c/a\u003e, one hasn’t been updated when new lint rules were added, one is still using old test runner.\u003c/li\u003e\u003cli\u003eAttempts to make a new repository to keep common code failed due to the amount of setup and code management. Imagine working with multiple team members on multiple repositories with multiple Pull Requests.\u003c/li\u003e\u003c/ul\u003e\u003cbr /\u003eAs you can see, while the projects are very different (check out \u003ca href=\"https://portal-sentry.swiggyapp.com/settings/swiggy/go-front-staging/keys/\"\u003eswiggy.com\u003c/a\u003e on your desktop and mobile to realize that), they still have quite a lot of common code interactions.\u003cbr /\u003e\u003cblockquote\u003eBike-shedding: Have you tried \u003ca href=\"https://www.swiggy.com?utm_source=medium\"\u003eSwiggy\u003c/a\u003e website on your desktop or mobile browser? We would love to hear your feedback!\u003c/blockquote\u003e\u003ch3\u003eThe how.\u003c/h3\u003e\u003cimg src=\"/img/blog/1__0WjBWfdkbcob39FMklwp7A.png\" alt=\"Logo of Lerna\"\u003e\u003cbr /\u003e\u003ca href=\"https://lerna.js.org/\"\u003ehttps://lerna.js.org/\u003c/a\u003e\u003cbr /\u003eDepending on your ecosystem, there will be different tools to help you with maintaining a Monorepo. You can obviously go vanilla and just use different folders per project. We use \u003ca href=\"https://lerna.js.org/\"\u003eLerna\u003c/a\u003e for maintaining our JavaScript codebase.\u003cbr /\u003eThanks to its community, there’s a \u003ca href=\"https://github.com/lerna/lerna/tree/master/commands/publish\"\u003elot\u003c/a\u003e \u003ca href=\"https://github.com/lerna/lerna/blob/master/FAQ.md\"\u003eof\u003c/a\u003e \u003ca href=\"https://lerna.js.org/#commands\"\u003edocumentation\u003c/a\u003e and \u003ca href=\"https://medium.com/mitterio/multirepo-to-lerna-js-monorepo-80f6657cb443\"\u003ehelp\u003c/a\u003e for Lerna \u003ca href=\"https://github.com/lerna/lerna/blob/master/doc/troubleshooting.md\"\u003erelated\u003c/a\u003e \u003ca href=\"https://github.com/lerna/lerna/blob/master/doc/guides.md\"\u003equeries\u003c/a\u003e.\u003cbr /\u003e\u003cpre class=\"code bash\"\u003e# Install lerna globally\nnpm i -g lerna\n\n# Change directory to your work folder\ncd ~/Work\n\n# Make the folder you want to keep your monorepo in\nmkdir portal-web\n\n# Change directory to monorepo folder\ncd portal-web\n\n# Initialize lerna (it will handle `git init`)\nlerna init\n\n# Commit the changes\ngit add . \u0026\u0026 git commit -m \u0026quot;Initial commit\u0026quot;\n\n# Import other packages (https://github.com/lerna/lerna/tree/master/commands/import)\nlerna import ~/Work/portal-mweb\n\n# That's pretty much it!\n\n# Fun fact: If you want to rename your package, simply rename the folder before importing.\n# Fun fact 2: You might need to flatten out the commits in most cases (https://github.com/lerna/lerna/tree/master/commands/import#--flatten)\u003c/pre\u003e\u003cbr /\u003eYou may use \u003ca href=\"https://gist.github.com/bogas04/874731db80967c040209fea396bf7804\"\u003eabove scripts\u003c/a\u003e to import existing repositories to a lerna based monorepo.\u003cbr /\u003eRunning scripts from the root has been made simpler using these handy \u003ca href=\"https://docs.npmjs.com/misc/scripts\"\u003enpm scripts\u003c/a\u003e.\u003cbr /\u003eThese scripts allow for convenient way to invoke package scripts from root folder\u003cbr /\u003eSince our packages are hosted in \u003ca href=\"https://verdaccio.org/\"\u003einternal npm registry\u003c/a\u003e, we inject a .npmrc in our \u003ca href=\"https://jenkins.io/\"\u003eJenkins\u003c/a\u003e build the pipeline to avoid committing the authToken.\u003cbr /\u003eA script to find all scoped dependencies of a project\u003cbr /\u003e\u003cpre class=\"code bash\"\u003e# Install monorepo dependencies from internal npm registry\nnpm i `../../scripts/scope-packages.js @portal`\n\n# Fun fact:\n# `npm i \u0026lt;package-name\u0026gt;` would also install other dependencies if they aren't present in node_modules,\n# along with the mentioned \u0026lt;package-name\u0026gt;\n\n# Fun fact 2:\n# In presence of package-lock.json, `npm i` would use those version numbers instead of fetching the latest ones\n# This essentially makes it a hybrid of `npm i` and `npm ci`\u003c/pre\u003e\u003cbr /\u003eOne interesting thing about \u003ca href=\"https://lerna.js.org/\"\u003eLerna\u003c/a\u003e is that it \u003ca href=\"https://gist.github.com/bogas04/8c9702aba064b03b1162a0058c7b8f98\"\u003edoesn’t\u003c/a\u003e want private packages to be part of the \u003ccode\u003epackage-lock.json.\u003c/code\u003e This means we can’t just simply use \u003ccode\u003enpm ci\u003c/code\u003e. We use this bash script to get past that.\u003ch3\u003eThe happy part.\u003c/h3\u003eWithin a few months of making this change, we tippled the number of packages in our Monorepo. We also saw much more work done on the linting front, leading to a more consistent codebase.\u003cbr /\u003eThe linter is common to entire Monorepo, and each new rule affects all the packages.\u003cbr /\u003e\u003cul\u003e\u003cli\u003e\u003cstrong\u003econfig\u003c/strong\u003e (webpack config as a package, reused by mweb and dweb)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003eui\u003c/strong\u003e (a package to create common patterns of design to be used in mobile and desktop, thus enabling us to work on creating a Swiggy’s design system)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003epayments\u003c/strong\u003e (a package of Swiggy’s payments page, used by multiple tenants)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003ereviews\u003c/strong\u003e (a package of Swiggy’s Ratings and Reviews page and components, used by mweb and dweb)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003ehelpers\u003c/strong\u003e (a package of common reusable logic, something like lodash)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003edaily\u003c/strong\u003e (swiggydaily.com, reuses 2 components from mweb)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003ecache\u003c/strong\u003e (a caching module used by mweb and dweb)\u003c/li\u003e\u003cli\u003e\u003cstrong\u003erestaurant-url\u003c/strong\u003e (a restaurant slug generator, multiple tenants)\u003c/li\u003e\u003c/ul\u003e\u003cbr /\u003e\u003cimg src=\"/img/blog/1__kvwGrM__62LBXWLHxH__QwGw.png\" alt=\"Image credits: undraw\"\u003e\u003cbr /\u003eI think that giving the option to easily create a new package incentivizes developers to think in more modular terms. They don’t think in the context of an app but rather in a more general way.\u003cbr /\u003eIt also discourages them from touching modules that are used by multiple tenants, and use \u003ca href=\"https://semver.org/\"\u003esemantic versioning\u003c/a\u003e appropriately.\u003cbr /\u003eThe benefits we are seeing out of this are just amazing:\u003cbr /\u003e\u003cul\u003e\u003cli\u003eWriting the same fix for dweb and mweb is faster, as it’s just one commit.\u003c/li\u003e\u003cli\u003eNo more \u003ccode\u003enpm link\u003c/code\u003e mess.\u003c/li\u003e\u003cli\u003eReviewing a fix for both dweb and mweb is faster, as it’s just one Pull Request on one repository by one team member.\u003c/li\u003e\u003cli\u003eReusing and updating build pipeline is much more seamless.\u003c/li\u003e\u003cli\u003eUpdating major dependencies/lint rules is super easy.\u003c/li\u003e\u003cli\u003eThe collocation of code encourages developers to copy-paste less and reuse more.\u003c/li\u003e\u003cli\u003eWriting reusable modules becomes easier, leading to better software engineering.\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003eThe sad part.\u003c/h3\u003eBut it ain’t all fun. Our PR section is a bit noisier. It’s not like we’re somehow writing more code, but that changes to any package comes to spotlight and doesn’t get silently updated.\u003cbr /\u003e\u003cul\u003e\u003cli\u003eToo many packages lead to longer bootstrap times.\u003c/li\u003e\u003cli\u003eLeveraging the benefits of Monorepo takes time.\u003c/li\u003e\u003cli\u003eThe code navigation is slightly slower. Developers are now opening individual packages to work around that.\u003c/li\u003e\u003c/ul\u003e\u003cbr /\u003e\u003cstrong\u003eUpdate:\u003c/strong\u003e There’s one more point I would like to touch upon. Our approach currently colocates applications with libraries. ‘mweb’ is a private package in the sense it isn’t published to our npm registry, however ‘ui’ is a public package that can be consumed by mulitple tenants. This leads to heterogeneity in the monorepo. We are okay with this mix as\u003cbr /\u003e\u003cul\u003e\u003cli\u003eit reduces friction of local development (no npm links).\u003c/li\u003e\u003cli\u003ecolocation leads to easy refactors and library creations.\u003c/li\u003e\u003cli\u003ecode review is simpler when it’s all one repository.\u003c/li\u003e\u003c/ul\u003e\u003ch3\u003eThe verdict.\u003c/h3\u003eSo far we’re seeing Monorepo architecture a better fit for our growing codebase and team. It also impacts the way we design new libraries and components, often promoting clearer separations of concerns.\u003cbr /\u003e\u003cimg src=\"/img/blog/1__O3UIYiDjYTXMAZd7GBMwVg.png\" alt=\"Image credits: undraw\"\u003e\u003cbr /\u003eShould you use monorepo? Like all things, it depends on TM! I hope this blog gave enough insight to you as to why we started using a Monorepo, and how it’s benefiting us.\u003cbr /\u003e\u003cblockquote\u003eDISCLAIMER: We don’t advocate for any of the tools, libraries, coding practices or software development philosophies mentioned here. You are welcome to read, learn, accept, reject and critique however you see fit.\u003c/blockquote\u003e"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"monorepos-lets-talk-about-it-9-17-2019"},"buildId":"x77_76NIwkTwQVLdJzAyE","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/runtime/polyfills-85bd6957125321bbf99b.js"></script><script async="" data-next-page="/_app" src="/_next/static/x77_76NIwkTwQVLdJzAyE/pages/_app.js"></script><script async="" data-next-page="/blog/[slug]" src="/_next/static/x77_76NIwkTwQVLdJzAyE/pages/blog/%5Bslug%5D.js"></script><script src="/_next/static/runtime/webpack-c212667a5f965e81e004.js" async=""></script><script src="/_next/static/chunks/framework.c6faae2799416a6da8e8.js" async=""></script><script src="/_next/static/chunks/8fa8195c484ff359de37c3e3df3e65db45e45c31.6410b8472f12f4cd5b7b.js" async=""></script><script src="/_next/static/chunks/f0ed4caab1caa1cdeb590ac7284e018c51b635b3.01cf6ee79894c0f4522a.js" async=""></script><script src="/_next/static/runtime/main-4cc3e642b9eb61ccb22a.js" async=""></script><script src="/_next/static/chunks/70596abf1b61d8bcb70c0714f534e0fb4f2d0437.402fba793ca95f8ab99b.js" async=""></script><script src="/_next/static/x77_76NIwkTwQVLdJzAyE/_buildManifest.js" async=""></script><script src="/_next/static/x77_76NIwkTwQVLdJzAyE/_ssgManifest.js" async=""></script></body></html>