<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><title>Monorepos, lets talk about it | Blog | Divjot Singh</title><meta name="title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta name="description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I‚Äôm guessing you must have faced some‚Ä¶"/><meta name="keywords" content="git, repository, monorepos, coding, lerna, javascript"/><meta property="og:type" content="website"/><meta property="og:url" content="https://bogas04.github.io/blog/monorepos-lets-talk-about-it-9-17-2019"/><meta property="og:title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta property="og:description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I‚Äôm guessing you must have faced some‚Ä¶"/><meta property="og:image" content="https://bogas04.github.io//img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png"/><meta property="twitter:card" content="summary_large_image"/><meta property="twitter:url" content="https://bogas04.github.io/blog/monorepos-lets-talk-about-it-9-17-2019"/><meta property="twitter:title" content="Monorepos, lets talk about it | Blog | Divjot Singh"/><meta property="twitter:description" content="Recall the days when you were just introduced to git or a similar type ofversion control system. I‚Äôm guessing you must have faced some‚Ä¶"/><meta property="twitter:image" content="https://bogas04.github.io//img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png"/><meta content="width=device-width,initial-scale=1" name="viewport"/><meta content="#333333" name="theme-color"/><script async="" src="https://unpkg.com/thesemetrics@latest"></script><meta name="next-head-count" content="18"/><link rel="preload" href="/_next/static/css/54a5524c8f603c74e0e1.css" as="style"/><link rel="stylesheet" href="/_next/static/css/54a5524c8f603c74e0e1.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-385d541686b65ec453f7.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.cb05d56be993eb6b088a.js" as="script"/><link rel="preload" href="/_next/static/chunks/bc2e07de48950c01b5237336b5f257227cc81ae6.ed5573c5ff9bc3fe6d1f.js" as="script"/><link rel="preload" href="/_next/static/chunks/e931326031e098825fea95581c2677695b95dc78.06aa71310da8759204a8.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-29dd914a6cacd949925e.js" as="script"/><link rel="preload" href="/_next/static/chunks/3a92620c9025e411d93647b35caeb6be300c1ea2.1fed5a83411791c98017.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5Bslug%5D-c156cbe69e9cfded461f.js" as="script"/><style data-styled="" data-styled-version="5.2.0"></style></head><body><div id="__next"><style>
        main {
            position: relative;
            max-width: 56em;
            background-color: white;
            padding: 2em;
            margin: 0 auto;
            box-sizing: border-box;
        }

        img {
            width: 100%;
        }

        @media (prefers-color-scheme: dark) {
            body,
            main {
                background: #333;
                color: white;
            }

            a {
                color: lightsalmon;
            }
        }
    </style><main><style>
  .content h2 {
    font-size: 1.6em;
    margin: 1em 0;
    font-weight: 500;
  }

  .content h3 {
    font-size: 1.2em;
    margin: 0.8em 0;
    font-weight: 500;
  }

  .content video {
    max-width: 100%;
  }

  .content img,
  .content video,
  .content h4 {
    margin: 1em 0;
  }

  .content pre {
    padding: 10px;
    font-size: 20px;
    line-height: 26px;
    overflow-x: auto;
  } 

  .content pre code {
    background-color: initial;
  }

  @media (prefers-color-scheme: dark) {
    .content pre {
      color: black;
    }
  }

  .content ul {
    line-height: 1.5;
  }

  .content li {
    margin: 0 0 0.5em 0;
  }
  h4 {
    text-transform: capitalize;
    margin-bottom: 2em;
  }
  h4 p{
    margin: 0.4em 0;
  }
  </style><h1>Monorepos, lets talk about it</h1><h4><a href="/">Divjot Singh</a> <!-- -->|<!-- --> <a href="/blog">Blog</a> <!-- -->| <!-- -->Tue Sep 17 2019<br/><p>git, repository, monorepos, coding, lerna, javascript</p></h4><div class="content"><p><img src="/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png" alt="Image credits: undraw"></p>
<p>Recall the days when you were just introduced to <code>git</code> or a similar type of version control system. I‚Äôm guessing you must have faced some friction initially, how it breaks your flow, how you just can‚Äôt merge to master without rebasing/merging changes in first.</p>
<p>Despite that, you might agree today that it‚Äôs actually very helpful in collaborating with the team, and those pain points were necessary to get here.</p>
<p>Monorepos are somewhat similar.</p>
<p>While git was solving problems around managing single codebase with multiple team members or just better versioning, Monorepo kind of does the same but for multiple projects/codebases.</p>
<h3 id="the-what"><a href="#the-what" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The what.</h3>
<blockquote>
<p>Is Monorepo that cool font I see on¬†Twitter?</p>
</blockquote>
<p><img src="/img/blog/1__ZzlBaQH6w1BgwZdo3bIYRQ.png" alt="Image credits: undraw"></p>
<p>Before diving into the topic, let‚Äôs first understand what Monorepo truly means. This is what Wikipedia has to say:</p>
<blockquote>
<p>In revision control systems, a Monorepo is a software development strategy where code for many projects are stored in the same repository.</p>
</blockquote>
<p>In other words, your ‚ÄòWork‚Äô folder is close to what a Monorepo would look like. It would have packages that deal with server, web app, native app, documentation, etc.</p>
<p>This is different from a ‚Äòmonolith‚Äô where all your application logic is<br>
centralized to one entry point as opposed to distributed services (microservices).</p>
<p>While code for various services would sit in a single repository, it doesn‚Äôt mean it would be deployed as a single entity, just like your ‚ÄòWork‚Äô folder. Individual projects have separate life-cycles.</p>
<h3 id="the-why"><a href="#the-why" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The why.</h3>
<blockquote>
<p>So, do I just <code>git add</code> my entire ‚ÄòWork‚Äô¬†folder?</p>
</blockquote>
<blockquote>
<p>‚ÄúWhy would you want to do this? Whatever happened to separation of concern?‚Äù</p>
</blockquote>
<p>There are several arguments both in favour and against Monorepos. And I don‚Äôt mean ‚ÄúOh Google uses it‚Äù kind of arguments. This blog will give a sneak-peek into our problems and Monorepo‚Äôs solutions to them.</p>
<p>Regardless, I recommend that you identify the problems your codebase is facing, and see if Monorepo is truly the answer to those.</p>
<h3 id="the-story"><a href="#the-story" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The story.</h3>
<p>Before moving to Monorepo, we as a team worked on 3 codebases at the same time;</p>
<ul>
<li><strong>dweb</strong> (Desktop website of Swiggy)</li>
<li><strong>mweb</strong> (Mobile website of Swiggy)</li>
<li><strong>service</strong> (API proxy NodeJS middleware, used by dweb and mweb)</li>
</ul>
<p>When I say work, I mean writing features, updating build pipeline, reviewing code and fixing bugs.</p>
<p>As the codebases grew, we recognized some patterns:</p>
<p><img src="/img/blog/1____L__bUfSLVT6EboXRO7SSGg.png" alt="Image credits:¬†undraw"></p>
<ul>
<li>Features written on mweb, while dissimilar enough to not to be dragged and dropped to dweb, held enough similarities to be broken into reusable parts.</li>
<li>Fixes that go on mweb are also needed on dweb.</li>
<li>Code reviewers often ended up reviewing the same code (between mweb and dweb) in a slightly different context.</li>
<li>Code review changes on dweb are also relevant to mweb</li>
<li>Changes to contracts of service, a common dependency, are also needed to be individually coded, tested, and reviewed.</li>
<li>Updating dependencies like <a href="https://reactjs.org/">React</a>/<a href="https://webpack.js.org/">Webpack</a>/<a href="https://babeljs.io/">Babel</a> becomes cumbersome between the two codebases.</li>
<li>Conventions are difficult to enforce between the three repositories. One has an older version of <a href="https://eslint.org/">ESLint</a>, one hasn‚Äôt been updated when new lint rules were added, one is still using old test runner.</li>
<li>Attempts to make a new repository to keep common code failed due to the amount of setup and code management. Imagine working with multiple team members on multiple repositories with multiple Pull Requests.</li>
</ul>
<p>As you can see, while the projects are very different (check out <a href="https://portal-sentry.swiggyapp.com/settings/swiggy/go-front-staging/keys/">swiggy.com</a> on your desktop and mobile to realize that), they still have quite a lot of common code interactions.</p>
<blockquote>
<p>Bike-shedding: Have you tried <a href="https://www.swiggy.com?utm_source=medium">Swiggy</a> website on your desktop or mobile browser? We would love to hear your feedback!</p>
</blockquote>
<h3 id="the-how"><a href="#the-how" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The how.</h3>
<p><img src="/img/blog/1__0WjBWfdkbcob39FMklwp7A.png" alt="Logo of Lerna"></p>
<p><a href="https://lerna.js.org/">https://lerna.js.org/</a></p>
<p>Depending on your ecosystem, there will be different tools to help you with maintaining a Monorepo. You can obviously go vanilla and just use different folders per project. We use <a href="https://lerna.js.org/">Lerna</a> for maintaining our JavaScript codebase.</p>
<p>Thanks to its community, there‚Äôs a <a href="https://github.com/lerna/lerna/tree/master/commands/publish">lot</a> <a href="https://github.com/lerna/lerna/blob/master/FAQ.md">of</a> <a href="https://lerna.js.org/#commands">documentation</a> and <a href="https://medium.com/mitterio/multirepo-to-lerna-js-monorepo-80f6657cb443">help</a> for Lerna <a href="https://github.com/lerna/lerna/blob/master/doc/troubleshooting.md">related</a> <a href="https://github.com/lerna/lerna/blob/master/doc/guides.md">queries</a>.</p>
<div class="remark-highlight"><pre class="language-bash"><code><span class="token comment"># Install lerna globally</span>
<span class="token function">npm</span> i -g lerna

<span class="token comment"># Change directory to your work folder</span>
<span class="token builtin class-name">cd</span> ~/Work

<span class="token comment"># Make the folder you want to keep your monorepo in</span>
<span class="token function">mkdir</span> portal-web

<span class="token comment"># Change directory to monorepo folder</span>
<span class="token builtin class-name">cd</span> portal-web

<span class="token comment"># Initialize lerna (it will handle `git init`)</span>
lerna init

<span class="token comment"># Commit the changes</span>
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span> <span class="token operator">&amp;&amp;</span> <span class="token function">git</span> commit -m <span class="token string">"Initial commit"</span>

<span class="token comment"># Import other packages (https://github.com/lerna/lerna/tree/master/commands/import)</span>
lerna <span class="token function">import</span> ~/Work/portal-mweb

<span class="token comment"># That's pretty much it!</span>

<span class="token comment"># Fun fact: If you want to rename your package, simply rename the folder before importing.</span>
<span class="token comment"># Fun fact 2: You might need to flatten out the commits in most cases (https://github.com/lerna/lerna/tree/master/commands/import#--flatten)</span>
</code></pre></div>
<p>You may use <a href="https://gist.github.com/bogas04/874731db80967c040209fea396bf7804">above scripts</a> to import existing repositories to a lerna based monorepo.</p>
<p>Running scripts from the root has been made simpler using these handy <a href="https://docs.npmjs.com/misc/scripts">npm scripts</a>.</p>
<p>These scripts allow for convenient way to invoke package scripts from root folder</p>
<p>Since our packages are hosted in <a href="https://verdaccio.org/">internal npm registry</a>, we inject a¬†.npmrc in our <a href="https://jenkins.io/">Jenkins</a> build the pipeline to avoid committing the authToken.</p>
<p>A script to find all scoped dependencies of a project</p>
<div class="remark-highlight"><pre class="language-bash"><code><span class="token comment"># Install monorepo dependencies from internal npm registry</span>
<span class="token function">npm</span> i <span class="token variable"><span class="token variable">`</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/scripts/scope-packages.js @portal<span class="token variable">`</span></span>

<span class="token comment"># Fun fact:</span>
<span class="token comment"># `npm i &lt;package-name&gt;` would also install other dependencies if they aren't present in node_modules,</span>
<span class="token comment"># along with the mentioned &lt;package-name&gt;</span>

<span class="token comment"># Fun fact 2:</span>
<span class="token comment"># In presence of package-lock.json, `npm i` would use those version numbers instead of fetching the latest ones</span>
<span class="token comment"># This essentially makes it a hybrid of `npm i` and `npm ci`</span>
</code></pre></div>
<p>One interesting thing about <a href="https://lerna.js.org/">Lerna</a> is that it <a href="https://gist.github.com/bogas04/8c9702aba064b03b1162a0058c7b8f98">doesn‚Äôt</a> want private packages to be part of the <code>package-lock.json.</code> This means we can‚Äôt just simply use <code>npm ci</code>. We use this bash script to get past that.</p>
<h3 id="the-happy-part"><a href="#the-happy-part" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The happy¬†part.</h3>
<p>Within a few months of making this change, we tippled the number of packages in our Monorepo. We also saw much more work done on the linting front, leading to a more consistent codebase.</p>
<p>The linter is common to entire Monorepo, and each new rule affects all the packages.</p>
<ul>
<li><strong>config</strong> (webpack config as a package, reused by mweb and dweb)</li>
<li><strong>ui</strong> (a package to create common patterns of design to be used in mobile and desktop, thus enabling us to work on creating a Swiggy‚Äôs design system)</li>
<li><strong>payments</strong> (a package of Swiggy‚Äôs payments page, used by multiple tenants)</li>
<li><strong>reviews</strong> (a package of Swiggy‚Äôs Ratings and Reviews page and components, used by mweb and dweb)</li>
<li><strong>helpers</strong> (a package of common reusable logic, something like lodash)</li>
<li><strong>daily</strong> (swiggydaily.com, reuses 2 components from mweb)</li>
<li><strong>cache</strong> (a caching module used by mweb and dweb)</li>
<li><strong>restaurant-url</strong> (a restaurant slug generator, multiple tenants)</li>
</ul>
<p><img src="/img/blog/1__kvwGrM__62LBXWLHxH__QwGw.png" alt="Image credits: undraw"></p>
<p>I think that giving the option to easily create a new package incentivizes developers to think in more modular terms. They don‚Äôt think in the context of an app but rather in a more general way.</p>
<p>It also discourages them from touching modules that are used by multiple tenants, and use <a href="https://semver.org/">semantic versioning</a> appropriately.</p>
<p>The benefits we are seeing out of this are just amazing:</p>
<ul>
<li>Writing the same fix for dweb and mweb is faster, as it‚Äôs just one commit.</li>
<li>No more <code>npm link</code> mess.</li>
<li>Reviewing a fix for both dweb and mweb is faster, as it‚Äôs just one Pull Request on one repository by one team member.</li>
<li>Reusing and updating build pipeline is much more seamless.</li>
<li>Updating major dependencies/lint rules is super easy.</li>
<li>The collocation of code encourages developers to copy-paste less and reuse more.</li>
<li>Writing reusable modules becomes easier, leading to better software engineering.</li>
</ul>
<h3 id="the-sad-part"><a href="#the-sad-part" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The sad¬†part.</h3>
<p>But it ain‚Äôt all fun. Our PR section is a bit noisier. It‚Äôs not like we‚Äôre somehow writing more code, but that changes to any package comes to spotlight and doesn‚Äôt get silently updated.</p>
<ul>
<li>Too many packages lead to longer bootstrap times.</li>
<li>Leveraging the benefits of Monorepo takes time.</li>
<li>The code navigation is slightly slower. Developers are now opening individual packages to work around that.</li>
</ul>
<p><strong>Update:</strong> There‚Äôs one more point I would like to touch upon. Our approach currently colocates applications with libraries. ‚Äòmweb‚Äô is a private package in the sense it isn‚Äôt published to our npm registry, however ‚Äòui‚Äô is a public package that can be consumed by mulitple tenants. This leads to heterogeneity in the monorepo. We are okay with this mix as</p>
<ul>
<li>it reduces friction of local development (no npm links).</li>
<li>colocation leads to easy refactors and library creations.</li>
<li>code review is simpler when it‚Äôs all one repository.</li>
</ul>
<h3 id="the-verdict"><a href="#the-verdict" aria-hidden="true" tabindex="-1"><span>üîó </span></a>The verdict.</h3>
<p>So far we‚Äôre seeing Monorepo architecture a better fit for our growing codebase and team. It also impacts the way we design new libraries and components, often promoting clearer separations of concerns.</p>
<p><img src="/img/blog/1__O3UIYiDjYTXMAZd7GBMwVg.png" alt="Image credits: undraw"></p>
<p>Should you use monorepo? Like all things, it depends on TM! I hope this blog gave enough insight to you as to why we started using a Monorepo, and how it‚Äôs benefiting us.</p>
<blockquote>
<p>DISCLAIMER: We don‚Äôt advocate for any of the tools, libraries, coding practices or software development philosophies mentioned here. You are welcome to read, learn, accept, reject and critique however you see¬†fit.</p>
</blockquote>
</div></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Monorepos, lets talk about it","description":"Recall the days when you were just introduced to git or a similar type ofversion control system. I‚Äôm guessing you must have faced some‚Ä¶","date":"2019-09-17T07:55:58.095Z","categories":"[]","keywords":["git","repository","monorepos","coding","lerna","javascript"],"slug":"monorepos-lets-talk-about-it-9-17-2019","isDraft":false,"image":"/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png","html":"\u003cp\u003e\u003cimg src=\"/img/blog/1__zWhHZUDWuxJwfEoumC1__OQ.png\" alt=\"Image credits: undraw\"\u003e\u003c/p\u003e\n\u003cp\u003eRecall the days when you were just introduced to \u003ccode\u003egit\u003c/code\u003e or a similar type of version control system. I‚Äôm guessing you must have faced some friction initially, how it breaks your flow, how you just can‚Äôt merge to master without rebasing/merging changes in first.\u003c/p\u003e\n\u003cp\u003eDespite that, you might agree today that it‚Äôs actually very helpful in collaborating with the team, and those pain points were necessary to get here.\u003c/p\u003e\n\u003cp\u003eMonorepos are somewhat similar.\u003c/p\u003e\n\u003cp\u003eWhile git was solving problems around managing single codebase with multiple team members or just better versioning, Monorepo kind of does the same but for multiple projects/codebases.\u003c/p\u003e\n\u003ch3 id=\"the-what\"\u003e\u003ca href=\"#the-what\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe what.\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIs Monorepo that cool font I see on¬†Twitter?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cimg src=\"/img/blog/1__ZzlBaQH6w1BgwZdo3bIYRQ.png\" alt=\"Image credits: undraw\"\u003e\u003c/p\u003e\n\u003cp\u003eBefore diving into the topic, let‚Äôs first understand what Monorepo truly means. This is what Wikipedia has to say:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIn revision control systems, a Monorepo is a software development strategy where code for many projects are stored in the same repository.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eIn other words, your ‚ÄòWork‚Äô folder is close to what a Monorepo would look like. It would have packages that deal with server, web app, native app, documentation, etc.\u003c/p\u003e\n\u003cp\u003eThis is different from a ‚Äòmonolith‚Äô where all your application logic is\u003cbr\u003e\ncentralized to one entry point as opposed to distributed services (microservices).\u003c/p\u003e\n\u003cp\u003eWhile code for various services would sit in a single repository, it doesn‚Äôt mean it would be deployed as a single entity, just like your ‚ÄòWork‚Äô folder. Individual projects have separate life-cycles.\u003c/p\u003e\n\u003ch3 id=\"the-why\"\u003e\u003ca href=\"#the-why\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe why.\u003c/h3\u003e\n\u003cblockquote\u003e\n\u003cp\u003eSo, do I just \u003ccode\u003egit add\u003c/code\u003e my entire ‚ÄòWork‚Äô¬†folder?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003e‚ÄúWhy would you want to do this? Whatever happened to separation of concern?‚Äù\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThere are several arguments both in favour and against Monorepos. And I don‚Äôt mean ‚ÄúOh Google uses it‚Äù kind of arguments. This blog will give a sneak-peek into our problems and Monorepo‚Äôs solutions to them.\u003c/p\u003e\n\u003cp\u003eRegardless, I recommend that you identify the problems your codebase is facing, and see if Monorepo is truly the answer to those.\u003c/p\u003e\n\u003ch3 id=\"the-story\"\u003e\u003ca href=\"#the-story\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe story.\u003c/h3\u003e\n\u003cp\u003eBefore moving to Monorepo, we as a team worked on 3 codebases at the same time;\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003edweb\u003c/strong\u003e (Desktop website of Swiggy)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003emweb\u003c/strong\u003e (Mobile website of Swiggy)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eservice\u003c/strong\u003e (API proxy NodeJS middleware, used by dweb and mweb)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWhen I say work, I mean writing features, updating build pipeline, reviewing code and fixing bugs.\u003c/p\u003e\n\u003cp\u003eAs the codebases grew, we recognized some patterns:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/blog/1____L__bUfSLVT6EboXRO7SSGg.png\" alt=\"Image credits:¬†undraw\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFeatures written on mweb, while dissimilar enough to not to be dragged and dropped to dweb, held enough similarities to be broken into reusable parts.\u003c/li\u003e\n\u003cli\u003eFixes that go on mweb are also needed on dweb.\u003c/li\u003e\n\u003cli\u003eCode reviewers often ended up reviewing the same code (between mweb and dweb) in a slightly different context.\u003c/li\u003e\n\u003cli\u003eCode review changes on dweb are also relevant to mweb\u003c/li\u003e\n\u003cli\u003eChanges to contracts of service, a common dependency, are also needed to be individually coded, tested, and reviewed.\u003c/li\u003e\n\u003cli\u003eUpdating dependencies like \u003ca href=\"https://reactjs.org/\"\u003eReact\u003c/a\u003e/\u003ca href=\"https://webpack.js.org/\"\u003eWebpack\u003c/a\u003e/\u003ca href=\"https://babeljs.io/\"\u003eBabel\u003c/a\u003e becomes cumbersome between the two codebases.\u003c/li\u003e\n\u003cli\u003eConventions are difficult to enforce between the three repositories. One has an older version of \u003ca href=\"https://eslint.org/\"\u003eESLint\u003c/a\u003e, one hasn‚Äôt been updated when new lint rules were added, one is still using old test runner.\u003c/li\u003e\n\u003cli\u003eAttempts to make a new repository to keep common code failed due to the amount of setup and code management. Imagine working with multiple team members on multiple repositories with multiple Pull Requests.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAs you can see, while the projects are very different (check out \u003ca href=\"https://portal-sentry.swiggyapp.com/settings/swiggy/go-front-staging/keys/\"\u003eswiggy.com\u003c/a\u003e on your desktop and mobile to realize that), they still have quite a lot of common code interactions.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eBike-shedding: Have you tried \u003ca href=\"https://www.swiggy.com?utm_source=medium\"\u003eSwiggy\u003c/a\u003e website on your desktop or mobile browser? We would love to hear your feedback!\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"the-how\"\u003e\u003ca href=\"#the-how\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe how.\u003c/h3\u003e\n\u003cp\u003e\u003cimg src=\"/img/blog/1__0WjBWfdkbcob39FMklwp7A.png\" alt=\"Logo of Lerna\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://lerna.js.org/\"\u003ehttps://lerna.js.org/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eDepending on your ecosystem, there will be different tools to help you with maintaining a Monorepo. You can obviously go vanilla and just use different folders per project. We use \u003ca href=\"https://lerna.js.org/\"\u003eLerna\u003c/a\u003e for maintaining our JavaScript codebase.\u003c/p\u003e\n\u003cp\u003eThanks to its community, there‚Äôs a \u003ca href=\"https://github.com/lerna/lerna/tree/master/commands/publish\"\u003elot\u003c/a\u003e \u003ca href=\"https://github.com/lerna/lerna/blob/master/FAQ.md\"\u003eof\u003c/a\u003e \u003ca href=\"https://lerna.js.org/#commands\"\u003edocumentation\u003c/a\u003e and \u003ca href=\"https://medium.com/mitterio/multirepo-to-lerna-js-monorepo-80f6657cb443\"\u003ehelp\u003c/a\u003e for Lerna \u003ca href=\"https://github.com/lerna/lerna/blob/master/doc/troubleshooting.md\"\u003erelated\u003c/a\u003e \u003ca href=\"https://github.com/lerna/lerna/blob/master/doc/guides.md\"\u003equeries\u003c/a\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode\u003e\u003cspan class=\"token comment\"\u003e# Install lerna globally\u003c/span\u003e\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i -g lerna\n\n\u003cspan class=\"token comment\"\u003e# Change directory to your work folder\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e ~/Work\n\n\u003cspan class=\"token comment\"\u003e# Make the folder you want to keep your monorepo in\u003c/span\u003e\n\u003cspan class=\"token function\"\u003emkdir\u003c/span\u003e portal-web\n\n\u003cspan class=\"token comment\"\u003e# Change directory to monorepo folder\u003c/span\u003e\n\u003cspan class=\"token builtin class-name\"\u003ecd\u003c/span\u003e portal-web\n\n\u003cspan class=\"token comment\"\u003e# Initialize lerna (it will handle `git init`)\u003c/span\u003e\nlerna init\n\n\u003cspan class=\"token comment\"\u003e# Commit the changes\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e \u003cspan class=\"token function\"\u003eadd\u003c/span\u003e \u003cspan class=\"token builtin class-name\"\u003e.\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token function\"\u003egit\u003c/span\u003e commit -m \u003cspan class=\"token string\"\u003e\"Initial commit\"\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Import other packages (https://github.com/lerna/lerna/tree/master/commands/import)\u003c/span\u003e\nlerna \u003cspan class=\"token function\"\u003eimport\u003c/span\u003e ~/Work/portal-mweb\n\n\u003cspan class=\"token comment\"\u003e# That's pretty much it!\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Fun fact: If you want to rename your package, simply rename the folder before importing.\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# Fun fact 2: You might need to flatten out the commits in most cases (https://github.com/lerna/lerna/tree/master/commands/import#--flatten)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eYou may use \u003ca href=\"https://gist.github.com/bogas04/874731db80967c040209fea396bf7804\"\u003eabove scripts\u003c/a\u003e to import existing repositories to a lerna based monorepo.\u003c/p\u003e\n\u003cp\u003eRunning scripts from the root has been made simpler using these handy \u003ca href=\"https://docs.npmjs.com/misc/scripts\"\u003enpm scripts\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThese scripts allow for convenient way to invoke package scripts from root folder\u003c/p\u003e\n\u003cp\u003eSince our packages are hosted in \u003ca href=\"https://verdaccio.org/\"\u003einternal npm registry\u003c/a\u003e, we inject a¬†.npmrc in our \u003ca href=\"https://jenkins.io/\"\u003eJenkins\u003c/a\u003e build the pipeline to avoid committing the authToken.\u003c/p\u003e\n\u003cp\u003eA script to find all scoped dependencies of a project\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-bash\"\u003e\u003ccode\u003e\u003cspan class=\"token comment\"\u003e# Install monorepo dependencies from internal npm registry\u003c/span\u003e\n\u003cspan class=\"token function\"\u003enpm\u003c/span\u003e i \u003cspan class=\"token variable\"\u003e\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e/\u003cspan class=\"token punctuation\"\u003e..\u003c/span\u003e/scripts/scope-packages.js @portal\u003cspan class=\"token variable\"\u003e`\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Fun fact:\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# `npm i \u0026lt;package-name\u0026gt;` would also install other dependencies if they aren't present in node_modules,\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# along with the mentioned \u0026lt;package-name\u0026gt;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# Fun fact 2:\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# In presence of package-lock.json, `npm i` would use those version numbers instead of fetching the latest ones\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# This essentially makes it a hybrid of `npm i` and `npm ci`\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eOne interesting thing about \u003ca href=\"https://lerna.js.org/\"\u003eLerna\u003c/a\u003e is that it \u003ca href=\"https://gist.github.com/bogas04/8c9702aba064b03b1162a0058c7b8f98\"\u003edoesn‚Äôt\u003c/a\u003e want private packages to be part of the \u003ccode\u003epackage-lock.json.\u003c/code\u003e This means we can‚Äôt just simply use \u003ccode\u003enpm ci\u003c/code\u003e. We use this bash script to get past that.\u003c/p\u003e\n\u003ch3 id=\"the-happy-part\"\u003e\u003ca href=\"#the-happy-part\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe happy¬†part.\u003c/h3\u003e\n\u003cp\u003eWithin a few months of making this change, we tippled the number of packages in our Monorepo. We also saw much more work done on the linting front, leading to a more consistent codebase.\u003c/p\u003e\n\u003cp\u003eThe linter is common to entire Monorepo, and each new rule affects all the packages.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003econfig\u003c/strong\u003e (webpack config as a package, reused by mweb and dweb)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eui\u003c/strong\u003e (a package to create common patterns of design to be used in mobile and desktop, thus enabling us to work on creating a Swiggy‚Äôs design system)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003epayments\u003c/strong\u003e (a package of Swiggy‚Äôs payments page, used by multiple tenants)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ereviews\u003c/strong\u003e (a package of Swiggy‚Äôs Ratings and Reviews page and components, used by mweb and dweb)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ehelpers\u003c/strong\u003e (a package of common reusable logic, something like lodash)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003edaily\u003c/strong\u003e (swiggydaily.com, reuses 2 components from mweb)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ecache\u003c/strong\u003e (a caching module used by mweb and dweb)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003erestaurant-url\u003c/strong\u003e (a restaurant slug generator, multiple tenants)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"/img/blog/1__kvwGrM__62LBXWLHxH__QwGw.png\" alt=\"Image credits: undraw\"\u003e\u003c/p\u003e\n\u003cp\u003eI think that giving the option to easily create a new package incentivizes developers to think in more modular terms. They don‚Äôt think in the context of an app but rather in a more general way.\u003c/p\u003e\n\u003cp\u003eIt also discourages them from touching modules that are used by multiple tenants, and use \u003ca href=\"https://semver.org/\"\u003esemantic versioning\u003c/a\u003e appropriately.\u003c/p\u003e\n\u003cp\u003eThe benefits we are seeing out of this are just amazing:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWriting the same fix for dweb and mweb is faster, as it‚Äôs just one commit.\u003c/li\u003e\n\u003cli\u003eNo more \u003ccode\u003enpm link\u003c/code\u003e mess.\u003c/li\u003e\n\u003cli\u003eReviewing a fix for both dweb and mweb is faster, as it‚Äôs just one Pull Request on one repository by one team member.\u003c/li\u003e\n\u003cli\u003eReusing and updating build pipeline is much more seamless.\u003c/li\u003e\n\u003cli\u003eUpdating major dependencies/lint rules is super easy.\u003c/li\u003e\n\u003cli\u003eThe collocation of code encourages developers to copy-paste less and reuse more.\u003c/li\u003e\n\u003cli\u003eWriting reusable modules becomes easier, leading to better software engineering.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"the-sad-part\"\u003e\u003ca href=\"#the-sad-part\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe sad¬†part.\u003c/h3\u003e\n\u003cp\u003eBut it ain‚Äôt all fun. Our PR section is a bit noisier. It‚Äôs not like we‚Äôre somehow writing more code, but that changes to any package comes to spotlight and doesn‚Äôt get silently updated.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eToo many packages lead to longer bootstrap times.\u003c/li\u003e\n\u003cli\u003eLeveraging the benefits of Monorepo takes time.\u003c/li\u003e\n\u003cli\u003eThe code navigation is slightly slower. Developers are now opening individual packages to work around that.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eUpdate:\u003c/strong\u003e There‚Äôs one more point I would like to touch upon. Our approach currently colocates applications with libraries. ‚Äòmweb‚Äô is a private package in the sense it isn‚Äôt published to our npm registry, however ‚Äòui‚Äô is a public package that can be consumed by mulitple tenants. This leads to heterogeneity in the monorepo. We are okay with this mix as\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eit reduces friction of local development (no npm links).\u003c/li\u003e\n\u003cli\u003ecolocation leads to easy refactors and library creations.\u003c/li\u003e\n\u003cli\u003ecode review is simpler when it‚Äôs all one repository.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"the-verdict\"\u003e\u003ca href=\"#the-verdict\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan\u003eüîó \u003c/span\u003e\u003c/a\u003eThe verdict.\u003c/h3\u003e\n\u003cp\u003eSo far we‚Äôre seeing Monorepo architecture a better fit for our growing codebase and team. It also impacts the way we design new libraries and components, often promoting clearer separations of concerns.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/blog/1__O3UIYiDjYTXMAZd7GBMwVg.png\" alt=\"Image credits: undraw\"\u003e\u003c/p\u003e\n\u003cp\u003eShould you use monorepo? Like all things, it depends on TM! I hope this blog gave enough insight to you as to why we started using a Monorepo, and how it‚Äôs benefiting us.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eDISCLAIMER: We don‚Äôt advocate for any of the tools, libraries, coding practices or software development philosophies mentioned here. You are welcome to read, learn, accept, reject and critique however you see¬†fit.\u003c/p\u003e\n\u003c/blockquote\u003e\n"}},"__N_SSG":true},"page":"/blog/[slug]","query":{"slug":"monorepos-lets-talk-about-it-9-17-2019"},"buildId":"naZOafuINf3kAz0Wl180_","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-83732ebf2ed7f8a1b2c7.js"></script><script src="/_next/static/chunks/main-385d541686b65ec453f7.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/framework.cb05d56be993eb6b088a.js" async=""></script><script src="/_next/static/chunks/bc2e07de48950c01b5237336b5f257227cc81ae6.ed5573c5ff9bc3fe6d1f.js" async=""></script><script src="/_next/static/chunks/e931326031e098825fea95581c2677695b95dc78.06aa71310da8759204a8.js" async=""></script><script src="/_next/static/chunks/pages/_app-29dd914a6cacd949925e.js" async=""></script><script src="/_next/static/chunks/3a92620c9025e411d93647b35caeb6be300c1ea2.1fed5a83411791c98017.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5Bslug%5D-c156cbe69e9cfded461f.js" async=""></script><script src="/_next/static/naZOafuINf3kAz0Wl180_/_buildManifest.js" async=""></script><script src="/_next/static/naZOafuINf3kAz0Wl180_/_ssgManifest.js" async=""></script></body></html>